---
- hosts: localhost
  connection: local
  gather_facts: false
  user: root
  tasks:
    #Creating a Key Pair for EC Instance
    - name: Create a new ec2 key pair
      ec2_key:
        name: ec2_keypair
        region: "{{ region }}"
      register: keypair

    - name: Copy EC2 Private Key locally for SSH into the instance
      copy: content="{{ keypair.key.private_key }}" dest={{ ec2_key_directory }}key.ppk
      when: keypair.changed == true

    #Creating and Launching EC2 instance
    - name: Create EC2 Instance
      ec2:
        image: ami-0d03e44a2333dea65
        wait: yes
        instance_type: t2.micro
        region: "{{ region }}"
        group_id: "{{ security_group.group_id }}"
        vpc_subnet_id: "{{ subnet.subnet.id }}"
        key_name: "{{ keypair.key.name  }}"
        instance_tags:
          app: jenkins
        count_tag:
          app: jenkins
        exact_count: 1
      register: ec2

    - name: Add the newly created host so that we can further contact it
      add_host:
        name: "{{ item.public_ip }}"
        groups: webservers
        ansible_ssh_private_key_file:  "{{ ec2_key_location }}"
      with_items: "{{ ec2.instances }}"

    - name: Add tag to Instance(s)
      ec2_tag:
        resource: "{{ item.id }}"
        region: "{{ region }}"
        state: "present"
      with_items: "{{ ec2.instances }}"
      args:
        tags:
          Type: webserver

    - name: Change file ownership, group and permissions
      file:
        path: "{{ ec2_key_location }}"
        mode: '600'      

    - name: Wait for SSH to come up
      wait_for:
        host: "{{ item.public_ip }}"
        port: 22
        state: started
      with_items: "{{ ec2.instances }}"
...
